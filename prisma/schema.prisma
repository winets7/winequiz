// =============================================
// üç∑ –í–∏–Ω–Ω–∞—è –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ ‚Äî –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
// =============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è (Enums)
// =============================================

enum Role {
  ADMIN
  PLAYER
}

enum GameStatus {
  WAITING
  PLAYING
  FINISHED
}

enum RoundStatus {
  CREATED  // –•–æ—Å—Ç –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  ACTIVE   // –£—á–∞—Å—Ç–Ω–∏–∫–∏ —É–≥–∞–¥—ã–≤–∞—é—Ç
  CLOSED   // –†–∞—É–Ω–¥ –∑–∞–∫—Ä—ã—Ç, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∫–∞–∑–∞–Ω—ã
}

enum WineSweetness {
  DRY        // –°—É—Ö–æ–µ
  SEMI_DRY   // –ü–æ–ª—É—Å—É—Ö–æ–µ
  SEMI_SWEET // –ü–æ–ª—É—Å–ª–∞–¥–∫–æ–µ
  SWEET      // –°–ª–∞–¥–∫–æ–µ
}

enum WineColor {
  RED    // –ö—Ä–∞—Å–Ω–æ–µ
  WHITE  // –ë–µ–ª–æ–µ
  ROSE   // –†–æ–∑–æ–≤–æ–µ
  ORANGE // –û—Ä–∞–Ω–∂–µ–≤–æ–µ
}

enum WineComposition {
  MONO  // –ú–æ–Ω–æ—Å–æ—Ä—Ç–æ–≤–æ–µ
  BLEND // –ë–ª–µ–Ω–¥
}

// =============================================
// –ú–æ–¥–µ–ª–∏ (–¢–∞–±–ª–∏—Ü—ã)
// =============================================

/// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∏–≥—Ä–æ–∫ –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
model User {
  id           String   @id @default(uuid())
  name         String
  phone        String   @unique
  passwordHash String
  avatar       String?
  role         Role     @default(PLAYER)
  level        Int      @default(1)
  xp           Int      @default(0)
  isProfilePublic Boolean @default(false) // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // –°–≤—è–∑–∏
  hostedGames      GameSession[]    @relation("HostedGames")
  gamePlayers       GamePlayer[]
  userAchievements  UserAchievement[]

  @@map("users")
}

/// –ò–≥—Ä–æ–≤–∞—è —Å–µ—Å—Å–∏—è (–∫–æ–º–Ω–∞—Ç–∞)
model GameSession {
  id           String     @id @default(uuid())
  hostId       String
  status       GameStatus @default(WAITING)
  code         String     @unique // –ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã, –Ω–∞–ø—Ä. "WN-482917"
  maxPlayers   Int        @default(99)
  currentRound Int        @default(0)
  totalRounds  Int        @default(5)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  finishedAt   DateTime?

  // –°–≤—è–∑–∏
  host    User         @relation("HostedGames", fields: [hostId], references: [id], onDelete: Cascade)
  players GamePlayer[]
  rounds  Round[]

  @@map("game_sessions")
}

/// –£—á–∞—Å—Ç–Ω–∏–∫ –∏–≥—Ä–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
model GamePlayer {
  id       String   @id @default(uuid())
  gameId   String
  userId   String
  score    Int      @default(0)
  position Int?
  joinedAt DateTime @default(now())

  // –°–≤—è–∑–∏
  game    GameSession   @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  guesses PlayerGuess[]

  @@unique([gameId, userId]) // –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –≤ –∏–≥—Ä–µ
  @@map("game_players")
}

/// –†–∞—É–Ω–¥ (–æ–¥–Ω–æ –∑–∞–≥–∞–¥–∞–Ω–Ω–æ–µ –≤–∏–Ω–æ)
model Round {
  id          String      @id @default(uuid())
  gameId      String
  roundNumber Int         // 1, 2, 3...
  status      RoundStatus @default(CREATED)

  // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ö–æ—Å—Ç)
  grapeVarieties  String[]         // –ú–∞—Å—Å–∏–≤ —Å–æ—Ä—Ç–æ–≤ ["–ö–∞–±–µ—Ä–Ω–µ –°–æ–≤–∏–Ω—å–æ–Ω", "–ú–µ—Ä–ª–æ"]
  sweetness       WineSweetness?
  vintageYear     Int?             // –ì–æ–¥ —É—Ä–æ–∂–∞—è
  country         String?          // –°—Ç—Ä–∞–Ω–∞
  alcoholContent  Float?           // –ö—Ä–µ–ø–æ—Å—Ç—å (–Ω–∞–ø—Ä. 13.5)
  isOakAged       Boolean?         // –í—ã–¥–µ—Ä–∂–∞–Ω–æ –ª–∏ –≤ –¥—É–±–æ–≤–æ–π –±–æ—á–∫–µ
  color           WineColor?
  composition     WineComposition?

  createdAt DateTime  @default(now())
  closedAt  DateTime?

  // –°–≤—è–∑–∏
  game    GameSession  @relation(fields: [gameId], references: [id], onDelete: Cascade)
  photos  RoundPhoto[]
  guesses PlayerGuess[]

  @@unique([gameId, roundNumber])
  @@map("rounds")
}

/// –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –±—É—Ç—ã–ª–∫–∏ (–∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ö–æ—Å—Ç)
model RoundPhoto {
  id        String @id @default(uuid())
  roundId   String
  imageUrl  String
  sortOrder Int    @default(0)

  // –°–≤—è–∑–∏
  round Round @relation(fields: [roundId], references: [id], onDelete: Cascade)

  @@map("round_photos")
}

/// –î–æ–≥–∞–¥–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –≤–∏–Ω–∞
model PlayerGuess {
  id           String @id @default(uuid())
  roundId      String
  gamePlayerId String

  // –î–æ–≥–∞–¥–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞
  grapeVarieties  String[]          // –ß—Ç–æ —É–∫–∞–∑–∞–ª —É—á–∞—Å—Ç–Ω–∏–∫
  sweetness       WineSweetness?
  vintageYear     Int?
  country         String?
  alcoholContent  Float?
  isOakAged       Boolean?
  color           WineColor?
  composition     WineComposition?

  score       Int      @default(0) // –ë–∞–ª–ª—ã –∑–∞ —Ä–∞—É–Ω–¥
  submittedAt DateTime @default(now())

  // –°–≤—è–∑–∏
  round      Round      @relation(fields: [roundId], references: [id], onDelete: Cascade)
  gamePlayer GamePlayer @relation(fields: [gamePlayerId], references: [id], onDelete: Cascade)

  @@unique([roundId, gamePlayerId]) // –û–¥–Ω–∞ –¥–æ–≥–∞–¥–∫–∞ –Ω–∞ —Ä–∞—É–Ω–¥ –∑–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞
  @@map("player_guesses")
}

/// –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ (—à–∞–±–ª–æ–Ω)
model Achievement {
  id          String @id @default(uuid())
  name        String @unique
  description String
  icon        String
  condition   String // JSON —Å —É—Å–ª–æ–≤–∏–µ–º: { "type": "total_games", "value": 10 }
  xpReward    Int    @default(50)

  // –°–≤—è–∑–∏
  userAchievements UserAchievement[]

  @@map("achievements")
}

/// –ü–æ–ª—É—á–µ–Ω–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ
model UserAchievement {
  id            String   @id @default(uuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())

  // –°–≤—è–∑–∏
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId]) // –û–¥–Ω–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ ‚Äî –æ–¥–∏–Ω —Ä–∞–∑
  @@map("user_achievements")
}
