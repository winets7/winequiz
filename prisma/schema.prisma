// =============================================
// üç∑ –í–∏–Ω–Ω–∞—è –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ ‚Äî –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
// =============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è (Enums)
// =============================================

enum Role {
  ADMIN
  PLAYER
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum GameStatus {
  WAITING
  PLAYING
  FINISHED
}

// =============================================
// –ú–æ–¥–µ–ª–∏ (–¢–∞–±–ª–∏—Ü—ã)
// =============================================

/// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∏–≥—Ä–æ–∫ –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
model User {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique
  passwordHash String
  avatar       String?
  role         Role     @default(PLAYER)
  level        Int      @default(1)
  xp           Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // –°–≤—è–∑–∏
  hostedGames      GameSession[]    @relation("HostedGames")
  gamePlayers       GamePlayer[]
  userAchievements  UserAchievement[]

  @@map("users")
}

/// –ö–∞—Ç–µ–≥–æ—Ä–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ (–ö—Ä–∞—Å–Ω–æ–µ, –ë–µ–ª–æ–µ, –†–µ–≥–∏–æ–Ω—ã, –°–æ—Ä—Ç–∞, –ò—Å—Ç–æ—Ä–∏—è...)
model Category {
  id        String   @id @default(uuid())
  name      String   @unique
  icon      String?
  createdAt DateTime @default(now())

  // –°–≤—è–∑–∏
  questions Question[]

  @@map("categories")
}

/// –í–æ–ø—Ä–æ—Å –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã
model Question {
  id         String     @id @default(uuid())
  text       String
  imageUrl   String?
  difficulty Difficulty @default(MEDIUM)
  timeLimit  Int        @default(15) // —Å–µ–∫—É–Ω–¥—ã
  categoryId String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // –°–≤—è–∑–∏
  category      Category       @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  answers       Answer[]
  playerAnswers PlayerAnswer[]

  @@map("questions")
}

/// –í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å
model Answer {
  id         String  @id @default(uuid())
  text       String
  isCorrect  Boolean @default(false)
  questionId String

  // –°–≤—è–∑–∏
  question      Question       @relation(fields: [questionId], references: [id], onDelete: Cascade)
  playerAnswers PlayerAnswer[]

  @@map("answers")
}

/// –ò–≥—Ä–æ–≤–∞—è —Å–µ—Å—Å–∏—è (–∫–æ–º–Ω–∞—Ç–∞)
model GameSession {
  id           String     @id @default(uuid())
  hostId       String
  status       GameStatus @default(WAITING)
  code         String     @unique // –ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã, –Ω–∞–ø—Ä. "WN-482917"
  maxPlayers   Int        @default(99)
  currentRound Int        @default(0)
  totalRounds  Int        @default(10)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  finishedAt   DateTime?

  // –°–≤—è–∑–∏
  host    User         @relation("HostedGames", fields: [hostId], references: [id], onDelete: Cascade)
  players GamePlayer[]

  @@map("game_sessions")
}

/// –£—á–∞—Å—Ç–Ω–∏–∫ –∏–≥—Ä–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
model GamePlayer {
  id       String   @id @default(uuid())
  gameId   String
  userId   String
  score    Int      @default(0)
  position Int?
  joinedAt DateTime @default(now())

  // –°–≤—è–∑–∏
  game          GameSession    @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  playerAnswers PlayerAnswer[]

  @@unique([gameId, userId]) // –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –≤ –∏–≥—Ä–µ
  @@map("game_players")
}

/// –û—Ç–≤–µ—Ç –∏–≥—Ä–æ–∫–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å –≤ —Ä–∞–º–∫–∞—Ö –∏–≥—Ä—ã
model PlayerAnswer {
  id           String   @id @default(uuid())
  gamePlayerId String
  questionId   String
  answerId     String?  // null –µ—Å–ª–∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª
  timeTaken    Int      @default(0) // –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
  points       Int      @default(0)
  isCorrect    Boolean  @default(false)
  answeredAt   DateTime @default(now())

  // –°–≤—è–∑–∏
  gamePlayer GamePlayer @relation(fields: [gamePlayerId], references: [id], onDelete: Cascade)
  question   Question   @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answer     Answer?    @relation(fields: [answerId], references: [id], onDelete: SetNull)

  @@unique([gamePlayerId, questionId]) // –û–¥–∏–Ω –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –∑–∞ –∏–≥—Ä—É
  @@map("player_answers")
}

/// –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ (—à–∞–±–ª–æ–Ω)
model Achievement {
  id          String @id @default(uuid())
  name        String @unique
  description String
  icon        String
  condition   String // JSON —Å —É—Å–ª–æ–≤–∏–µ–º: { "type": "total_correct", "value": 100 }
  xpReward    Int    @default(50)

  // –°–≤—è–∑–∏
  userAchievements UserAchievement[]

  @@map("achievements")
}

/// –ü–æ–ª—É—á–µ–Ω–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ
model UserAchievement {
  id            String   @id @default(uuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())

  // –°–≤—è–∑–∏
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId]) // –û–¥–Ω–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ ‚Äî –æ–¥–∏–Ω —Ä–∞–∑
  @@map("user_achievements")
}
