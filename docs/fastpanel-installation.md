# Установка Fastpanel на сервере

Инструкция по [документации Timeweb Cloud](https://timeweb.cloud/docs/control-panels/fastpanel/fastpanel-installation).

## Что такое Fastpanel

Бесплатная панель управления сервером с русской локализацией: сайты, почта, БД, бэкапы. Для работы нужна **бесплатная лицензия** (оформляется после установки).

## Поддерживаемые ОС

- Debian 9 и новее
- Ubuntu 18.04 и новее
- CentOS 7
- AlmaLinux 8
- Rocky Linux 8

У сервера должен быть **публичный IPv4**.

---

## Вариант 1: Автоматическая установка (при создании VDS)

1. В панели облака: **Облачные серверы** → **Создать** / **Добавить**.
2. Вкладка **Маркетплейс** → выбрать **Fastpanel** и нужную версию Ubuntu.
3. Задать регион, конфигурацию, сеть (обязательно публичный IPv4).
4. Нажать **Заказать**.

Реквизиты доступа (адрес, логин, пароль) придут на почту. Далее — выпуск лицензии (см. ниже).

---

## Вариант 2: Ручная установка на существующий сервер

### Шаг 1. Подключение по SSH

Подключитесь к серверу по SSH **от пользователя `root`**:

```bash
ssh root@IP_АДРЕС_ВАШЕГО_СЕРВЕРА
```

(В Windows можно использовать PowerShell с OpenSSH или PuTTY.)

### Шаг 2. Запуск установщика

Выполните на сервере одну команду:

```bash
wget http://repo.fastpanel.direct/install_fastpanel.sh -O - | bash -
```

Дождитесь окончания установки. В конце в терминале появятся **адрес панели, логин и пароль** — сохраните их.

### Шаг 3. Выпуск лицензии

1. Откройте в браузере: **https://IP_АДРЕС_СЕРВЕРА:8888/**
   - При автоустановке адрес есть в письме или в панели Timeweb Cloud.
   - При ручной установке — в выводе установщика в терминале.

2. На странице панели укажите **e-mail** для запроса лицензии.

3. На почту придёт письмо от Fastpanel — перейдите по **ссылке подтверждения**.

4. Откроется вход в личный кабинет Fastpanel:
   - если аккаунта нет — нажмите **Sign up** (достаточно e-mail, логин/пароль пришлют на почту);
   - если есть — введите e-mail и пароль.

5. В личном кабинете: **Мои услуги** — проверьте, что лицензия для вашего IP выпущена.

6. Вернитесь на вкладку с панелью (**https://IP_АДРЕС_СЕРВЕРА:8888/**) и нажмите **Проверить статус**. После этого откроется панель управления сервером.

---

## Доступ к панели на этом сервере

- **URL:** https://85.239.48.51:8888/
- **Логин:** `fastuser`
- **Пароль:** см. у администратора (устанавливается командой `passwd fastuser` на сервере)

---

## Пошаговая инструкция после установки

### Шаг 1. Открыть панель в браузере

1. Откройте в браузере: **https://85.239.48.51:8888/**
2. Если браузер предупреждает о сертификате — примите исключение (самоподписанный сертификат) или нажмите «Дополнительно» → «Перейти на сайт».

### Шаг 2. Войти в панель

1. В поле **Пользователь** введите: `fastuser`
2. В поле **Пароль** введите пароль (тот, что был задан при установке; если забыли — см. раздел «Сброс пароля» ниже).
3. Нажмите **Войти**.

### Шаг 3. Выпустить лицензию (обязательно при первом входе)

1. Если панель показывает запрос лицензии — введите свой **e-mail** и отправьте запрос.
2. Откройте почту и найдите письмо от Fastpanel.
3. Перейдите по **ссылке из письма**.
4. Откроется сайт Fastpanel (cp.fastpanel.direct):
   - если аккаунта нет — нажмите **Sign up** и зарегистрируйтесь (достаточно e-mail);
   - если аккаунт есть — войдите по e-mail и паролю.
5. В личном кабинете откройте **Мои услуги** и убедитесь, что лицензия для IP **85.239.48.51** выпущена.
6. Вернитесь на вкладку с панелью (**https://85.239.48.51:8888/**) и нажмите **Проверить статус**. После этого откроется интерфейс панели.

### Шаг 4. Первая настройка (по желанию)

- В разделе **Настройки** можно сменить язык, пароль, настроить уведомления.
- В разделе **Сайты** можно создавать новые сайты (см. ниже про winequiz).

### Шаг 5. Размещение сайта winequiz в Fastpanel

Проект winequiz — это Next.js (порт 3000) и сокет-сервер (порт 3001), они уже развёрнуты в `/var/www/winequiz` и запускаются через PM2. Варианты:

**Вариант A — сайт в панели с прокси на Node**

1. В Fastpanel: **Сайты** → **Создать сайт**.
2. Укажите домен (или временно IP, например `85.239.48.51`).
3. После создания сайта откройте карточку сайта → **Настройки** (или **Конфигурация**).
4. Добавьте **обратный прокси** на `http://127.0.0.1:3000` (основное приложение).
5. **Обязательно для лобби («Онлайн» и «Начать игру»):** добавьте прокси для Socket.io на порт 3001. В nginx это обычно отдельный `location`:
   - Путь: `/socket.io/` → проксировать на `http://127.0.0.1:3001`.
   - Включите поддержку WebSocket: `Upgrade`, `Connection "upgrade"`, `proxy_http_version 1.1`.
   Точные пункты меню зависят от версии панели (часто «Прокси» / «Backend» / «Дополнительная конфигурация nginx»). Без этого клиент будет показывать «Подключение...» вместо «Онлайн».

**Вариант B — оставить текущую схему (nginx отдельно)**

- Сейчас порт 80 занят Apache (установленным Fastpanel). Чтобы снова отдавать winequiz по 80, нужно либо переключить сайт в панели на ваш домен и настроить прокси (как в варианте A), либо вручную вернуть конфигурацию nginx для winequiz и решить конфликт портов (например, отключить Apache для 80 или отдать 80 nginx).

Рекомендация: использовать **вариант A** — один сайт в Fastpanel с прокси на `127.0.0.1:3000` и при необходимости на 3001, чтобы всё управлялось из панели.

### Просмотр баз данных в Fastpanel

1. Войдите в панель: **https://85.239.48.51:8888/** (или ваш адрес).
2. В левом меню откройте **«Настройки»** (или **«Сервисы»** / **«Базы данных»** — название зависит от версии).
3. Перейдите в раздел **«Базы данных»**.
4. В списке отображаются базы данных, созданные через панель (обычно **MySQL**). Для них есть кнопка **«Открыть phpMyAdmin»** — по ней можно зайти в веб-интерфейс и смотреть/редактировать таблицы.

**Важно:** Сайт winequiz использует **PostgreSQL** (база `winequiz_db`). Она могла быть создана вручную или через скрипты, а не через Fastpanel. В панели по умолчанию управляют в основном MySQL; список баз в разделе «Базы данных» может не показывать PostgreSQL.

**Как посмотреть PostgreSQL (winequiz_db):**

- **Через SSH:** подключитесь к серверу и выполните:
  ```bash
  sudo -u postgres psql -d winequiz_db -c "\dt"
  ```
  (список таблиц) или откройте интерактивную консоль: `sudo -u postgres psql -d winequiz_db`.
- **Через веб-интерфейс:** установите на сервер, например, **pgAdmin** или **phpPgAdmin**, настройте доступ и откройте его по поддомену или порту. Либо используйте локальный клиент (DBeaver, pgAdmin на ПК), подключившись к `85.239.48.51:5432` с учётными данными из `.env` проекта (пользователь и пароль из `DATABASE_URL`).

### Вход в профиль на сайте winequiz (vintaste.ru)

Вход выполняется по **номеру телефона** и паролю (не по e-mail). В форме входа поле «Номер телефона» должно содержать 11 цифр, например `8 (000) 000-00-00` или `80000000000`.

- **Тестовый админ** (если выполнялся seed): телефон `80000000000`, пароль из `prisma/seed.ts` (по умолчанию `Sva8601729*-+`). Если пароль меняли — используйте свой.
- **Гостевые пользователи** (guest_…@winequiz.local) не имеют пароля и не могут войти через «Телефон и пароль» — только зарегистрированные пользователи с паролем.

Если при входе появляется ошибка (CredentialsSignin), проверьте:
1. Вводите именно **телефон** в формате 8XXXXXXXXXX (или с маской).
2. Пароль совпадает с тем, что задавали при регистрации.
3. В логах приложения нет ошибок подключения к БД (см. `pm2 logs winequiz-web`).

Ошибки **Failed to find Server Action "x"** часто связаны с устаревшим билдом после деплоя. На сервере выполните: `cd /var/www/winequiz && npm run build && pm2 restart winequiz-web winequiz-socket`.

### Смена пароля базы данных PostgreSQL (winequiz_db)

Если при создании базы вы оставили пароль-заглушку (например, `ваш_надежный_пароль`), его можно сменить так.

**1. Подключитесь к серверу по SSH:**

```bash
ssh root@85.239.48.51
```

**2. Смените пароль пользователя PostgreSQL** (подставьте имя пользователя из вашего `DATABASE_URL` — часто это `postgres` или отдельный пользователь для winequiz):

```bash
sudo -u postgres psql -c "ALTER USER postgres PASSWORD 'ваш_новый_надежный_пароль';"
```

Если пользователь другой (например, `winequiz`), замените `postgres` на него в обеих местах:

```bash
sudo -u postgres psql -c "ALTER USER winequiz PASSWORD 'ваш_новый_надежный_пароль';"
```

**3. Обновите пароль в `.env` на сервере:**

```bash
nano /var/www/winequiz/.env
```

Найдите строку `DATABASE_URL` и замените старый пароль на новый в URL, например:

```
DATABASE_URL="postgresql://postgres:ваш_новый_надежный_пароль@localhost:5432/winequiz_db"
```

Сохраните файл (Ctrl+O, Enter, Ctrl+X).

**4. Перезапустите приложение**, чтобы оно подхватило новый пароль:

```bash
cd /var/www/winequiz && pm2 restart winequiz-web winequiz-socket
```

После этого приложение будет подключаться к БД с новым паролем.

---

### Сброс пароля fastuser (если забыли)

Подключитесь к серверу по SSH и выполните одну из команд.

**Задать пароль вручную:**

```bash
ssh root@85.239.48.51
passwd fastuser
```

Введите новый пароль дважды.

**Сгенерировать и установить случайный пароль (выведется в терминал):**

```bash
ssh root@85.239.48.51 'PASS=$(head -c 100 /dev/urandom | tr -dc "A-Za-z0-9" | head -c 12); echo "fastuser:$PASS" | chpasswd; echo "Логин: fastuser, Пароль: $PASS"'
```

---

## Полезные ссылки

- [Демо Fastpanel](https://fastpanel.direct/) — для ознакомления с интерфейсом
- [Документация Timeweb: установка Fastpanel](https://timeweb.cloud/docs/control-panels/fastpanel/fastpanel-installation)
